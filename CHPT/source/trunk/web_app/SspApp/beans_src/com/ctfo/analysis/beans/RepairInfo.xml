<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RepairInfo">
  <typeAlias alias="dynamicSqlParameter" type="com.ctfo.local.obj.DynamicSqlParameter" />
  <resultMap class="com.ctfo.analysis.beans.RepairInfo" id="RepairInfo">
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Mon Mar 24 16:46:46 CST 2014.
    -->
    <result column="SER_STATION_ID" jdbcType="VARCHAR" property="serStationId" />
    <result column="MAINTAIN_ID" jdbcType="VARCHAR" property="maintainId" />
    <result column="COM_CODE" jdbcType="VARCHAR" property="comCode" />
    <result column="COM_NAME" jdbcType="VARCHAR" property="comName" />
    <result column="SETBOOK_NAME" jdbcType="VARCHAR" property="setbookName" />
    <result column="PROVINCE" jdbcType="VARCHAR" property="province" />
    <result column="CITY" jdbcType="VARCHAR" property="city" />
    <result column="COUNTY" jdbcType="VARCHAR" property="county" />
    
    <result column="REPAIR_COUNT" jdbcType="VARCHAR" property="repairCount" />
    <result column="REPAIR_PROJECT" jdbcType="BIGINT" property="repairProject" nullValue="0"/>
    <result column="REPAIR_SETTLEMENT" jdbcType="BIGINT" property="repairSettlement" nullValue="0"/>
    <result column="MANHOUR_COST" jdbcType="BIGINT" property="manHourCost" nullValue="0"/>
    <result column="ACCESSORIES" jdbcType="BIGINT" property="accessories" nullValue="0"/>
    <result column="ACCESSORIES_SETTLEMENT" jdbcType="BIGINT" property="accessoriesSettlement" nullValue="0"/>
    
     <result column="START_TIME" jdbcType="VARCHAR" property="startTime" />
     <result column="END_TIME" jdbcType="VARCHAR" property="endTime" />
  </resultMap>
  <sql id="where">
    WHERE 1=1
  </sql> 
  <sql id="where_param">
    <include refid="where" />
    <include refid="equal_WHERE" />
    <include refid="like_WHERE" />
  </sql>
  <sql id="equal_WHERE">
    <isNotNull prepend="AND" property="equal.province">
      book.province =  #equal.province:VARCHAR#
    </isNotNull>
    <isNotNull prepend="AND" property="equal.city">
      book.city =  #equal.city:VARCHAR#
    </isNotNull>
    <isNotNull prepend="AND" property="equal.county">
      book.county =  #equal.county:VARCHAR#
    </isNotNull>    
    <isNotNull prepend="AND" property="equal.settlementTimeStart">
        <![CDATA[(#equal.settlementTimeStart:VARCHAR# <= mq.create_time )]]>
    </isNotNull>
    <isNotNull prepend="AND" property="equal.settlementTimeEnd">
        <![CDATA[(#equal.settlementTimeEnd:VARCHAR# >= mq.create_time )]]>
    </isNotNull>
  </sql> 
  <sql id="like_WHERE">
  	<isNotNull prepend="AND" property="like.comName">
      com.com_name like CONCAT('%',#like.comName:VARCHAR#,'%')
    </isNotNull>
  	<isNotNull prepend="AND" property="like.setbookName">
      book.setbook_name like CONCAT('%',#like.setbookName:VARCHAR#,'%')
    </isNotNull>    
  </sql> 
  <select id="countParam" parameterClass="dynamicSqlParameter" resultClass="int">
    SELECT COUNT(1) FROM 
	( SELECT 
	      dan.ser_station_id,
		  dan.maintain_id AS maintain_id,
		  com.com_code AS com_code,
		  com.com_name AS com_name,
		  book.setbook_name AS setbook_name,
		  book.province AS province,
		  book.city AS city,
		  book.county AS county,
		  mq.create_time,
		  IFNULL(sq.total_dan,0) AS repair_count,
		  IFNULL(dq.total_xiang,0) AS repair_project,
		  IFNULL(mq.sum_jie,0) AS repair_settlement,
		  IFNULL(mq.sum_gong,0) AS MANHOUR_COST,
		  IFNULL(rq.total_peishu,0) AS accessories,
		  IFNULL(mq.sum_peijie,0) AS accessories_settlement
		FROM
		  tb_maintain_info dan
		  LEFT JOIN  tb_company com 
		    ON dan.ser_station_id = com.ser_station_id
		  LEFT JOIN sys_setbook book
		    ON dan.set_book_id = book.set_book_id
		  LEFT JOIN (
			SELECT COUNT(maintain_id) AS total_dan,maintain_id FROM tb_maintain_info GROUP BY set_book_id
		  ) sq ON dan.maintain_id = sq.maintain_id
		  LEFT JOIN (
			SELECT COUNT(item_id) AS total_xiang,maintain_id FROM tb_maintain_item GROUP BY set_book_id
		  ) dq ON dan.maintain_id = dq.maintain_id
		   LEFT JOIN (
			SELECT SUM(should_sum) AS sum_jie,SUM(man_hour_sum) AS sum_gong,SUM(fitting_sum) AS sum_peijie,create_time,maintain_id FROM tb_maintain_settlement_info GROUP BY set_book_id
		  ) mq ON dan.maintain_id = mq.maintain_id
		   LEFT JOIN (
			SELECT COUNT(material_id) AS total_peishu,maintain_id FROM tb_maintain_material_detail GROUP BY set_book_id
		  ) rq ON dan.maintain_id = rq.maintain_id
	     <include refid="where_param" />
		 GROUP BY dan.set_book_id
	    ) BB
  </select>
  <select id="selectPageForParam" parameterClass="dynamicSqlParameter" resultMap="RepairInfo">
		SELECT BB.* FROM 
	    ( SELECT 
	      dan.ser_station_id,
		  dan.maintain_id AS maintain_id,
		  com.com_code AS com_code,
		  com.com_name AS com_name,
		  book.setbook_name AS setbook_name,
		  book.province AS province,
		  book.city AS city,
		  book.county AS county,
		  mq.create_time,
		  IFNULL(sq.total_dan,0) AS repair_count,
		  IFNULL(dq.total_xiang,0) AS repair_project,
		  IFNULL(mq.sum_jie,0) AS repair_settlement,
		  IFNULL(mq.sum_gong,0) AS MANHOUR_COST,
		  IFNULL(rq.total_peishu,0) AS accessories,
		  IFNULL(mq.sum_peijie,0) AS accessories_settlement,
		  #equal.settlementTimeStart:VARCHAR# START_TIME,
		  #equal.settlementTimeEnd:VARCHAR# END_TIME
		FROM
		  tb_maintain_info dan
		  LEFT JOIN  tb_company com 
		    ON dan.ser_station_id = com.ser_station_id
		  LEFT JOIN sys_setbook book
		    ON dan.set_book_id = book.set_book_id
		  LEFT JOIN (
			SELECT COUNT(maintain_id) AS total_dan,maintain_id FROM tb_maintain_info GROUP BY set_book_id
		  ) sq ON dan.maintain_id = sq.maintain_id
		  LEFT JOIN (
			SELECT COUNT(item_id) AS total_xiang,maintain_id FROM tb_maintain_item GROUP BY set_book_id
		  ) dq ON dan.maintain_id = dq.maintain_id
		   LEFT JOIN (
			SELECT SUM(should_sum) AS sum_jie,SUM(man_hour_sum) AS sum_gong,SUM(fitting_sum) AS sum_peijie,create_time,maintain_id FROM tb_maintain_settlement_info GROUP BY set_book_id
		  ) mq ON dan.maintain_id = mq.maintain_id
		   LEFT JOIN (
			SELECT COUNT(material_id) AS total_peishu,maintain_id FROM tb_maintain_material_detail GROUP BY set_book_id
		  ) rq ON dan.maintain_id = rq.maintain_id
	     <include refid="where_param" />
		 GROUP BY dan.set_book_id
	    ) BB 
	    LIMIT #startNum#,#pagesize#
  </select>
  
</sqlMap>